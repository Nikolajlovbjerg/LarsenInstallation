@using Core
@inject NavigationManager Nav
@inject HttpClient Http

<div class="create-page-back">
    <div class="create-con">
        <h3>Opret projekt</h3>

        <EditForm Model="@_project" OnValidSubmit="OnClickCreate">
            
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="upload-grid">
                <div class="upload-box">
                    <label class="upload-title"><strong>Vælg time fil (.xls, .xlsx)</strong></label>
                    <div class="upload-area">
                        <InputFile OnChange="OnTimeFileChange" multiple accept=".xls,.xlsx" />
                        @if (timeFiles?.Count > 0)
                        {
                            <div class="mt-2 small">
                                Valgte:
                                <ul>
                                    @foreach (var f in timeFiles)
                                    {
                                        <li>
                                            <span class="file-name">@f.Name</span>
                                            <span class="file-size">(@(f.Size / 1024) KB)</span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>

                <div class="upload-box">
                    <label class="upload-title"><strong>Vælg materiale fil (.xls, .xlsx)</strong></label>
                    <div class="upload-area">
                        <InputFile OnChange="OnMaterialFileChange" multiple accept=".xls,.xlsx" />
                        @if (materialFiles?.Count > 0)
                        {
                            <div class="mt-2 small">
                                Valgte:
                                <ul>
                                    @foreach (var f in materialFiles)
                                    {
                                        <li>
                                            <span class="file-name">@f.Name</span>
                                            <span class="file-size">(@(f.Size / 1024) KB)</span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="form-floating-group">
                <InputText id="name" class="form-control" @bind-Value="_project.Name"/>
                <label for="name">Navn</label>
            </div>
                
            <div class="form-grid">
                <div class="form-floating-group">
                    <InputNumber id="svend" class="form-control" @bind-Value="_project.SvendTimePris"/>
                    <label for="svend">Svend sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="lærling" class="form-control" @bind-Value="_project.LærlingTimePris"/>
                    <label for="lærling">Lærling sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="konsulent" class="form-control" @bind-Value="_project.KonsulentTimePris"/>
                    <label for="konsulent">Konsulent sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="arbejdsmand" class="form-control" @bind-Value="_project.ArbjedsmandTimePris"/>
                    <label for="konsulent">Arbejdsmand sats</label>
                </div>
            </div>
                
            <div class="">
                <div class="">
                    <button type="submit" class="opretbtn">Opret</button>
                </div>
            </div>
            
        </EditForm>
        
        
    </div>
</div>


@code {
    private Project _project = new();
    private IReadOnlyList<IBrowserFile> timeFiles = new List<IBrowserFile>();
    private IReadOnlyList<IBrowserFile> materialFiles = new List<IBrowserFile>();
    
    private string statusMessage = "";
    private string statusClass = "";
    private const long MaxFileSize = 50 * 1024 * 1024; // 50 MB

    // Simple one-liner handlers
    private void OnTimeFileChange(InputFileChangeEventArgs e) => timeFiles = e.GetMultipleFiles();
    private void OnMaterialFileChange(InputFileChangeEventArgs e) => materialFiles = e.GetMultipleFiles();

    private async Task OnClickCreate()
    {
        statusMessage = "";

        // Simpel validering
        if (string.IsNullOrWhiteSpace(_project.Name))
        {
            ShowError("Husk at give projektet et navn.");
            return;
        }

        if (!timeFiles.Any() && !materialFiles.Any())
        {
            ShowError("Du skal vælge mindst én fil.");
            return;
        }

        try 
        {
            using var content = new MultipartFormDataContent();

            // Tilføj Projekt JSON
            content.Add(JsonContent.Create(_project), "project");

            // Brug hjælpefunktion til at tilføje filer
            AddFilesToContent(content, timeFiles, "timeFile");
            AddFilesToContent(content, materialFiles, "materialFile");

            var resp = await Http.PostAsync("api/project", content);

            if (resp.IsSuccessStatusCode)
            {
                Nav.NavigateTo("projects", true);
            }
            else
            {
                ShowError(await resp.Content.ReadAsStringAsync());
            }
        }
        catch (Exception ex)
        {
            ShowError($"Fejl: {ex.Message}");
        }
    }

    // Hjælpefunktion der fjerner gentagelser
    private void AddFilesToContent(MultipartFormDataContent content, IEnumerable<IBrowserFile> files, string formName)
    {
        foreach (var file in files)
        {
            var streamContent = new StreamContent(file.OpenReadStream(MaxFileSize));
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType);
            content.Add(streamContent, formName, file.Name);
        }
    }

    private void ShowError(string msg)
    {
        statusMessage = msg;
        statusClass = "alert-danger";
    }
}