@page "/adminuser"
@using Core
@using Client.Service
@inject HttpClient Http
@inject NavigationManager Nav


<div class="admin-container">
    <div class="header-section">
        <h3>Brugeradministration</h3>
        <button class="btn btn-create" @onclick="CreateUser">
            <i class="bi bi-plus-lg"></i> Opret ny bruger
        </button>
    </div>

    @if (_users == null)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Indlæser brugere...</p>
        </div>
    }
    else if (_users.Count == 0)
    {
        <div class="empty-state">
            <p>Ingen brugere fundet i systemet.</p>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Brugernavn</th>
                        <th>Rolle</th>
                        <th class="text-end">Handling</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in _users)
                    {
                        <tr>
                            <td>#@user.UserId</td>
                            <td>
                                <span class="fw-bold">@user.UserName</span>
                            </td>
                            <td>
                                @* Giver rollen en lille badge for bedre visuelt overblik *@
                                <span class="badge @GetRoleBadgeClass(user.Role)">
                                    @user.Role
                                </span>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-delete" 
                                        @onclick="() => DeleteUser(user.UserId)">
                                    <i class="bi bi-trash"></i> Slet
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Users>? _users = new();

    // Henter listen af brugere når siden startes
    protected override async Task OnInitializedAsync()
    {
        _users = await Http.GetFromJsonAsync<List<Users>>($"{Server.Url}/api/user");
    }

    private async Task DeleteUser(int id)
    {
        // Sender slette-kommando til API'et
        var response = await Http.DeleteAsync($"{Server.Url}/api/user/delete/{id}");
    
        if (response.IsSuccessStatusCode)
        {
            // Hvis sletningen gik godt, henter vi listen på ny for at opdatere tabellen
            _users = await Http.GetFromJsonAsync<List<Users>>($"{Server.Url}/api/user");
        }
    }

    // Hjælpemetode (Switch expression) til at vælge CSS-klasse baseret på rollens navn
    private string GetRoleBadgeClass(string role)
    {
        return role.ToLower() switch
        {
            "admin" => "bg-danger",   // Rød
            "bruger" => "bg-primary", // Blå
            _ => "bg-secondary"       // Grå (hvis andet)
        };
    }

    private void CreateUser()
    {
        Nav.NavigateTo("adduser");
    }
}