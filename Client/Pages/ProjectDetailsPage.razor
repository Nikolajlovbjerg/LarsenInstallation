@page "/project/{Id:int}"
@using Core
@inject HttpClient Http

<PageTitle>Projekt Detaljer</PageTitle>

@if (details == null)
{
    <p><em>Indlæser beregninger...</em></p>
}
else
{
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>@details.Project.Name</h1>
                <span class="badge bg-secondary">Oprettet: @details.Project.DateCreated.ToShortDateString()</span>
            </div>

            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="clientViewSwitch" 
                       @bind="showClientView" style="cursor: pointer; width: 3em; height: 1.5em;">
                <label class="form-check-label ms-2 fw-bold" for="clientViewSwitch" style="padding-top: 4px;">
                    @(showClientView ? "Kundevisning: AKTIV" : "Kundevisning: Inaktiv")
                </label>
            </div>
        </div>

        @if (showClientView)
        {
            /* ========================================== */
            /* KUNDEVISNING (Opdelt i bokse)              */
            /* ========================================== */

            <div class="card text-white bg-success mb-4 shadow text-center">
                <div class="card-body py-4">
                    <h2 class="display-3 fw-bold">@details.SamletTotalPris.ToString("N2") kr.</h2>
                    <p class="fs-5 mb-0">Samlet tilbudspris</p>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card h-100 shadow-sm text-center border-success">
                        <div class="card-header bg-transparent border-success fw-bold text-success">
                            Materialer
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <div>
                                <h3 class="card-title text-dark">@details.TotalPrisMaterialer.ToString("N2") kr.</h3>
                                <small class="text-muted">Salg af materialer</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm text-center border-success">
                        <div class="card-header bg-transparent border-success fw-bold text-success">
                            Arbejdsløn
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <div>
                                <h3 class="card-title text-dark">@details.TotalPrisTimer.ToString("N2") kr.</h3>
                                <small class="text-muted">Total for timer</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card h-100 shadow-sm text-center border-success">
                        <div class="card-header bg-transparent border-success fw-bold text-success">
                            Estimeret tid
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <div>
                                <h3 class="card-title text-dark">@details.TotalTimer.ToString("N2") timer</h3>
                                <small class="text-muted">Samlet tidsforbrug</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-5">
                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-success">
                        <div class="card-header bg-transparent border-success fw-bold text-success">
                            Timeoversigt
                        </div>
                        <ul class="list-group list-group-flush">
                            @foreach (var group in GetHoursByType())
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@group.Type</span>
                                    <span class="badge bg-success rounded-pill">@group.Total.ToString("N2") t</span>
                                </li>
                            }
                        </ul>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100 shadow-sm border-success">
                        <div class="card-header bg-transparent border-success fw-bold text-success">
                            Væsentligste materialer (Top 5)
                        </div>
                        <ul class="list-group list-group-flush">
                            @foreach (var mat in GetTopMaterials())
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 70%;" title="@mat.Beskrivelse">
                                        @mat.Beskrivelse
                                    </span>
                                    <span class="fw-bold">@mat.Total.ToString("N2") kr.</span>
                                </li>
                            }
                            @if (!details.Materials.Any())
                            {
                                <li class="list-group-item text-muted text-center">Ingen materialer registreret</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }
        else
        {
            /* ========================================== */
            /* INTERN VISNING (Originale data + DB)       */
            /* ========================================== */
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-white bg-success mb-3 h-100">
                        <div class="card-header">Total pris (Salgspris)</div>
                        <div class="card-body">
                            <h3 class="card-title">@details.SamletTotalPris.ToString("N2") kr.</h3>
                            <p class="card-text">
                                Materialer: @details.TotalPrisMaterialer.ToString("N0")<br />
                                Arbejdsløn: @details.TotalPrisTimer.ToString("N0")
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card text-dark bg-light mb-3 h-100">
                        <div class="card-header">Samlet Kostpris (Internt)</div>
                        <div class="card-body">
                            <h3 class="card-title">@details.SamletKostPris.ToString("N2") kr.</h3>
                            <p class="card-text">
                                Materialer: @details.TotalKostPrisMaterialer.ToString("N0")<br />
                                Lønudgift: @details.TotalKostPrisTimer.ToString("N0")
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card text-white bg-primary mb-3 h-100">
                        <div class="card-header">Dækningsbidrag</div>
                        <div class="card-body">
                            <h3 class="card-title">@details.Dækningsbidrag.ToString("N2") kr.</h3>
                            <p class="card-text">
                                Dækningsgrad: <strong>@details.Dækningsgrad.ToString("N1") %</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        }
        
        @if (!showClientView)
        {
            <div class="mt-5">
                <h3>Timeregistreringer (@details.TotalTimer timer)</h3>
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Dato</th>
                            <th>Type</th>
                            <th>Timer</th>
                            <th>Kostpris</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var h in details.Hours)
                        {
                            <tr>
                                <td>@(h.Dato?.ToShortDateString() ?? "-")</td>
                                <td>@h.Type</td>
                                <td>@h.Timer</td>
                                <td>@h.Kostpris</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Calculation? details;
    private bool showClientView = false;

    protected override async Task OnInitializedAsync()
    {
        details = await Http.GetFromJsonAsync<Calculation>($"api/createproject/{Id}");
    }

    // Hjælpemetode til at gruppere timer (Svend, Lærling etc.)
    private List<HourGroup> GetHoursByType()
    {
        if (details?.Hours == null) return new List<HourGroup>();

        return details.Hours
            .GroupBy(h => {
                var t = h.Type?.ToLower() ?? "";
                if (t.Contains("lærling")) return "Lærling";
                if (t.Contains("konsulent")) return "Konsulent";
                if (t.Contains("arbejdsmand")) return "Arbejdsmand";
                return "Svend"; // Standard kategori
            })
            .Select(g => new HourGroup { Type = g.Key, Total = g.Sum(x => x.Timer) })
            .OrderByDescending(x => x.Total)
            .ToList();
    }

    // Hjælpemetode til at hente Top 5 dyreste materialer
    private List<ProjectMaterial> GetTopMaterials()
    {
        if (details?.Materials == null) return new List<ProjectMaterial>();

        return details.Materials
            .OrderByDescending(m => m.Total) // Sorterer efter dyreste totalpris
            .Take(5)
            .ToList();
    }

    // Simpel klasse til gruppering (kun til visning her)
    public class HourGroup
    {
        public string Type { get; set; } = "";
        public decimal Total { get; set; }
    }
}