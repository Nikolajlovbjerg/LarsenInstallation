
// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Components\CreateProjectComponent.razor -----

@page "/create-project"
@using Core
@inject Client.Service.ProjectService ProjectService
@inject NavigationManager Nav

<div class="create-page-back">
    <div class="create-con">
        <h3>Opret projekt</h3>

        <EditForm Model="@_project" OnValidSubmit="OnClickCreate">
            <div class="upload-grid">
                <div class="upload-box">
                    <label class="upload-title"><strong>V√¶lg time fil</strong></label>
                    <div class="upload-area">
                        <InputFile class="hidden-file-input" multiple />
                    </div>
                </div>

                <div class="upload-box">
                    <label class="upload-title"><strong>V√¶lg materiale fil</strong></label>
                    <div class="upload-area">
                        <InputFile class="hidden-file-input" multiple />
                    </div>
                </div>
            </div>

            <div class="form-floating-group">
                <InputText id="name" class="form-control" @bind-Value="_project.Name" />
                <label for="name">Navn</label>
            </div>

            <div class="form-grid">
                <div class="form-floating-group">
                    <InputNumber id="svend" class="form-control" @bind-Value="_project.SvendTimePris" />
                    <label for="svend">Svend sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="l√¶rling" class="form-control" @bind-Value="_project.L√¶rlingTimePris" />
                    <label for="l√¶rling">L√¶rling sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="konsulent" class="form-control" @bind-Value="_project.KonsulentTimePris" />
                    <label for="konsulent">Konsulent sats</label>
                </div>
                <div class="form-floating-group">
                    <InputNumber id="arbejdsmand" class="form-control" @bind-Value="_project.ArbejdsmandTimePris" />
                    <label for="arbejdsmand">Arbejdsmand sats</label>
                </div>
            </div>

            <button type="submit" class="opretbtn">Opret</button>
        </EditForm>
    </div>
</div>

@code {
    private Project _project = new();

    private async Task OnClickCreate()
    {
        var created = await ProjectService.CreateProject(_project);

        if (created != null)
        {
            Nav.NavigateTo("/projects");
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Components\ProjectRapport.razor -----

@using Core

@if (Project == null)
{
    <p>Projektet blev ikke fundet!</p>
}
else
{
    <div class="project-info">
        <h4>@Project.Name</h4>
        <p>Oprettet: @Project.DateCreated.ToShortDateString()</p>

        <h5>Omkostninger</h5>
        <p>Total pris for kunden: @(Project.TotalCostCustomer.ToString("C"))</p>
        <p>Virksomhedens omkostninger: @(Project.TotalCostCompany.ToString("C"))</p>
        <p>Overskud: @((Project.TotalCostCustomer - Project.TotalCostCompany).ToString("C"))</p>
    </div>

    @foreach (var house in Project.Houses)
    {
        <div class="house-report">
            <h4>@house.Name</h4>
            <p>Pris kunde: @(house.CostCustomer.ToString("C"))</p>
            <p>Omkostninger: @(house.CostCompany.ToString("C"))</p>
            <p>Overskud: @((house.CostCustomer - house.CostCompany).ToString("C"))</p>
            <p>Timer brugt: @house.Hours</p>

            <h5>Installationer</h5>
            <ul>
                @foreach (var inst in house.InstallationCosts)
                {
                    <li>@inst.Key: @(inst.Value.ToString("C"))</li>
                }
            </ul>

            <h5>Materialer</h5>
            <ul>
                @foreach (var mat in house.MaterialsUsed)
                {
                    <li>@mat.Key: @mat.Value stk</li>
                }
            </ul>
        </div>
    }

    <h5>Tidsforbrug pr. dag</h5>
    <ul>
        @foreach (var entry in Project.TimeEntries)
        {
            <li>@entry.Date.ToShortDateString(): @entry.Hours timer</li>
        }
    </ul>
}

@code {
    [Parameter] public Project? Project { get; set; }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Components\ProjectsList.razor -----

@using Core

<div class="annonce-list">
    @foreach (var p in Projects)
    {
        <article class="annonce-card">
            <div class="content">
                <h3 class="title">@p.Name</h3>
                <p>Oprettet: @p.DateCreated.ToShortDateString()</p>
            </div>

            <button class="btn mark-sold" @onclick="@(() => OnSeeMore?.Invoke(p.ProjectId))">Se mere</button>
        </article>
    }
</div>

@code {
    [Parameter] public IEnumerable<Project>? Projects { get; set; }
    [Parameter] public Action<int>? OnSeeMore { get; set; }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Layout\MainLayout.razor -----

@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@using Core
@inject NavigationManager navManager
@inherits LayoutComponentBase
<div class="page">
    @if (isLoggedIn)
    {
        <div class="sidebar">
            <NavMenu/>
        </div>

        <main>
            <div class="top-row px-2 btn-primary" style="color: white">
            <NavLink class="nav-link" href="logout" @onclick="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-door-closed" viewBox="0 0 16 16">
                    <path d="M3 2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v13h1.5a.5.5 0 0 1 0 1h-13a.5.5 0 0 1 0-1H3zm1 13h8V2H4z"/>
                    <path d="M9 9a1 1 0 1 0 2 0 1 1 0 0 0-2 0"/>
                </svg> Log out
            </NavLink>
            </div>
            <article class="content px-4">
                @Body
            </article>
        </main>
    }
</div>

@code
{
    bool isLoggedIn = false;

    protected override async Task OnInitializedAsync()
    {
        var user = await LocalStorage.GetItemAsync<Users>("user");
        isLoggedIn = user != null;
    }
    
    private async Task Logout()
    { 
        await LocalStorage.RemoveItemAsync("user");
        navManager.NavigateTo("/", true);
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Layout\NavMenu.razor -----

@using Core
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager navManager


<div class="logo-con">
    <div class="m-4">
        <img src="Assets/Larsen-logo_2021hvid.png" class="logo-larsen"/>
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/>
            </svg></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable" @onclick="ToggleNavMenu">
    <nav class="nav flex-column h-100">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="projects" Match="NavLinkMatch.All">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16">
                    <path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a2 2 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139q.323-.119.684-.12h5.396z"/>
                </svg> Projects
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="CreateProjectPage">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-plus" viewBox="0 0 16 16">
                    <path d="M8.5 6a.5.5 0 0 0-1 0v1.5H6a.5.5 0 0 0 0 1h1.5V10a.5.5 0 0 0 1 0V8.5H10a.5.5 0 0 0 0-1H8.5z"/>
                    <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1"/>
                </svg> Opret projekt
            </NavLink>
        </div>
        
        @if (loggedIn != null && loggedIn.Role.Equals("admin", StringComparison.CurrentCultureIgnoreCase))
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="adduser">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-receipt-cutoff" viewBox="0 0 16 16">
                        <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5M11.5 4a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1zm0 2a.5.5 0 0 0 0 1h1a.5.5 0 0 0 0-1z" />
                        <path d="M2.354.646a.5.5 0 0 0-.801.13l-.5 1A.5.5 0 0 0 1 2v13H.5a.5.5 0 0 0 0 1h15a.5.5 0 0 0 0-1H15V2a.5.5 0 0 0-.053-.224l-.5-1a.5.5 0 0 0-.8-.13L13 1.293l-.646-.647a.5.5 0 0 0-.708 0L11 1.293l-.646-.647a.5.5 0 0 0-.708 0L9 1.293 8.354.646a.5.5 0 0 0-.708 0L7 1.293 6.354.646a.5.5 0 0 0-.708 0L5 1.293 4.354.646a.5.5 0 0 0-.708 0L3 1.293zm-.217 1.198.51.51a.5.5 0 0 0 .707 0L4 1.707l.646.647a.5.5 0 0 0 .708 0L6 1.707l.646.647a.5.5 0 0 0 .708 0L8 1.707l.646.647a.5.5 0 0 0 .708 0L10 1.707l.646.647a.5.5 0 0 0 .708 0L12 1.707l.646.647a.5.5 0 0 0 .708 0l.509-.51.137.274V15H2V2.118z" />
                    </svg> Tilf¯j bruger
                </NavLink>
            </div>
        }
        
    </nav>
</div>




@code {
    private bool collapseNavMenu = true;

    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;

    private void ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
    }

    Users? loggedIn;

    protected override async Task OnInitializedAsync()
    {
        loggedIn = await LocalStorage.GetItemAsync<Users?>("user");
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\AddUser.razor -----

@page "/adduser"
@using Core
@inject HttpClient http
@inject NavigationManager navMan

<PageTitle>Add User</PageTitle>

<h3>Add User</h3>

<EditForm Model="@_user" OnValidSubmit="@HandleValidSubmit" class="row p-3">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="col-md-12 mb-3">
        <label for="UserName">User Name</label>
        <InputText id="UserName" @bind-Value="_user.UserName" class="form-control" />
    </div>

    <div class="col-md-12 mb-3">
        <label for="Password">Password</label>
        <InputText id="Password" @bind-Value="_user.Password" class="form-control" type="password" />
    </div>

    <div class="col-md-12 mb-3">
        <label for="Role">Role</label>
        <InputSelect id="Role" @bind-Value="_user.Role" class="form-select" >

            @foreach (var r in roles)
            {
                <option value="@r">@r</option>
            }
        </InputSelect>
    </div>

    <div class="col-12 mb-3">
        <button type="submit" class="btn btn-primary">Add User</button>
    </div>
</EditForm>

@code {
    private Users _user = new();

    private string[] roles = ["Bruger", "Admin"];

    private async Task HandleValidSubmit()
    {
        // Sender POST request direkte til API'et
        var response = await http.PostAsJsonAsync("http://localhost:5028/api/user", _user);

        if (response.IsSuccessStatusCode)
        {
            // Clear form
            _user = new Users();
            // Naviger tilbage til brugersiden (juster route som ¯nsket)
            navMan.NavigateTo("/");
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\CreateProjectPage.razor -----

@page "/CreateProjectPage"
@using Client.Components


<CreateProjectComponent></CreateProjectComponent>

@code {
    
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\Home.razor -----

@page "/"

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\LoginPage.razor -----

@using Core
@using Blazored.LocalStorage
@using Client.Service
@inject ILocalStorageService LocalStorage
@inject NavigationManager Nav
@inject Client.Service.UserRepository UserRepo
@page "/login"
<PageTitle>Log ind</PageTitle>

<div class="login-page-back">
    <div class="login-con">
        <h3>Log ind</h3>

        <EditForm Model="@user" OnValidSubmit="OnClickLogin">
            <div class="form-floating-group">
                <InputText id="un" class="form-control" @bind-Value="user.UserName" placeholder="Username" />
                <label for="un">Username</label>
            </div>

            <div class="form-floating-group">
                <InputText id="pwd"
                           type="@PasswordType"
                           class="form-control"
                           @bind-Value="user.Password"
                           placeholder="Password" />
                <label for="pwd">Password</label>

                <!-- Brug en button type="button" s√• vi ikke utilsigtet submitter formen -->
                <button type="button" class="btn btn-link p-0" @onclick="TogglePasswordVisibility" aria-label="Toggle password visibility">
                    <i class="bi @(visPassword ? "bi-eye-slash" : "bi-eye")"></i>
                </button>
            </div>

            <div style="text-align: center">
                <button type="submit" class="btn btn-primary" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span class="visually-hidden"> Logging in...</span>
                    }
                    else
                    {
                        <span>Login</span>
                    }
                </button>
            </div>
        </EditForm>

        @if (!string.IsNullOrEmpty(errorText))
        {
            <div class="error-message">
                <span class="error-icon">‚ö†Ô∏è</span>
                <span class="error-text">@errorText</span>
            </div>
        }
    </div>
</div>

@code {
    Users user = new();
    string errorText = "";
    bool visPassword = false;
    bool isLoading = false;

    string PasswordType => visPassword ? "text" : "password";

    void TogglePasswordVisibility()
    {
        visPassword = !visPassword;
    }

    private async Task OnClickLogin()
    {
        errorText = "";
        isLoading = true;

        try
        {
            // Kald den asynkrone metode i din UserRepository (som bruger HttpClient)
            Users? userObject = await UserRepo.ValidLoginAsync(user.UserName, user.Password);

            if (userObject == null)
            {
                errorText = "Forkert brugernavn eller adgangskode ‚Äî pr√∏v igen.";
                isLoading = false;
                return;
            }

            // Fjern adgangskoden f√∏r vi gemmer i localStorage (GEM ALDRIG password i klartekst)
            try
            {
                userObject.Password = string.Empty; // eller null afh√¶ngig af modellen
            }
            catch
            {
                // Hvis Users.Password er readonly eller lign., lav et lille DTO i stedet:
                var safeUser = new { userObject.UserName, userObject.Role, /* evt. Id = userObject.Id */ };
                await LocalStorage.SetItemAsync("user", safeUser);
                Nav.NavigateTo("projects", forceLoad: true);
                return;
            }

            await LocalStorage.SetItemAsync("user", userObject);
            Nav.NavigateTo("projects", forceLoad: true);
        }
        catch (HttpRequestException)
        {
            errorText = "Netv√¶rksfejl ‚Äî kunne ikke kontakte serveren. Tjek at serveren k√∏rer og CORS er korrekt sat op.";
        }
        catch (Exception ex)
        {
            errorText = $"Der skete en fejl: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\ProjectPage.razor -----

@page "/projects"
@using Client.Components
@using Core
@inject NavigationManager Navigation

<h3>Projekter</h3>

<ProjectsList Projects="@projectList" OnSeeMore="@NavigateToDetails"></ProjectsList>

@code {
    private List<Project> projectList = new()
    {
        new Project { ProjectId = 1, Name = "Gadehj¯rnet", DateCreated = DateTime.Now },
        new Project { ProjectId = 2, Name = "Projekt B", DateCreated = DateTime.Now.AddDays(-1) },
        new Project { ProjectId = 3, Name = "Mand¯vÊnget", DateCreated = DateTime.Now.AddDays(-2) }
    };

    private void NavigateToDetails(int projectId)
    {
        Navigation.NavigateTo($"/projects/{projectId}");
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Pages\ProjektDetails.razor -----

@page "/projects/{ProjectId:int}"
@using Core
@using Client.Components;

<h3>Projekt detaljer</h3>

<ProjectRapport Project="@project" />

@code {
    [Parameter] public int ProjectId { get; set; }
    private Project? project;

    protected override void OnInitialized()
    {
        // Dummy data
        project = new Project
        {
            ProjectId = ProjectId,
            Name = $"Projekt {ProjectId}",
            DateCreated = DateTime.Now.AddDays(-5),
            TotalCostCustomer = 50000,
            TotalCostCompany = 35000,
            SvendTimePris = 300,
            LÊrlingTimePris = 150,
            KonsulentTimePris = 500,
            ArbejdsmandTimePris = 200,
            Houses = new List<House>
            {
                new House
                {
                    Name = "Hus 1",
                    CostCustomer = 20000,
                    CostCompany = 14000,
                    Hours = 80,
                    InstallationCosts = new Dictionary<string, decimal>
                    {
                        { "Stikkontakter", 1000 },
                        { "Belysning", 2000 }
                    },
                    MaterialsUsed = new Dictionary<string,int>
                    {
                        { "Ledninger", 50 },
                        { "Stik", 20 }
                    }
                }
            }
        };
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Service\ProjectService.cs -----

using Core;
using System.Net.Http.Json;

namespace Client.Service
{
    public class ProjectService
    {
        private readonly HttpClient _http;

        public ProjectService(HttpClient http)
        {
            _http = http;
        }

        public async Task<Project?> CreateProject(Project project)
        {
            var response = await _http.PostAsJsonAsync("api/project", project);

            return await response.Content.ReadFromJsonAsync<Project>();
        }

        public async Task<List<Project>> GetProjects()
        {
            return await _http.GetFromJsonAsync<List<Project>>("api/project");
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Service\UserRepository.cs -----

using Core;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;

namespace Client.Service
{
    public class UserRepository
    {
        private readonly HttpClient _http;

        public UserRepository(HttpClient http)
        {
            _http = http;
        }
        
        public async Task<Users?> ValidLoginAsync(string name, string password)
        {
            var login = new { UserName = name, Password = password };
            HttpResponseMessage response;

            try
            {
                response = await _http.PostAsJsonAsync("/api/user/login", login);
            }
            catch (Exception)
            {
                return null;
            }

            if (response.IsSuccessStatusCode)
            {
                var user = await response.Content.ReadFromJsonAsync<Users>();
                return user;
            }
            
            return null;
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\App.razor -----

@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Nav
@using Client.Pages

@if (!initialized)
{
    <!-- small placeholder while we read local storage -->
    <div></div>
}
else if (!isLoggedIn)
{
    <!-- Render the LoginPage component directly if not logged in -->
    <LoginPage/>
}
else
{
    <Router AppAssembly="@typeof(App).Assembly">
        <Found Context="routeData">
            <RouteView RouteData="@routeData" DefaultLayout="@typeof(Client.Layout.MainLayout)" />
            <FocusOnNavigate RouteData="@routeData" Selector="h1" />
        </Found>
        <NotFound>
            <LayoutView Layout="@typeof(Client.Layout.MainLayout)">
                <p>Page not found.</p>
            </LayoutView>
        </NotFound>
    </Router>
}

@code
{
    private bool initialized = false;
    private bool isLoggedIn = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var user = await LocalStorage.GetItemAsync<object>("user");
            isLoggedIn = user != null;
        }
        catch (Exception)
        {
            // If localStorage read fails, treat as not logged in
            isLoggedIn = false;
        }
        initialized = true;
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\Program.cs -----

using Microsoft.AspNetCore.Components.Web;
using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
using Client;
using Blazored.LocalStorage;
using Client.Service;
using Microsoft.Extensions.DependencyInjection;

var builder = WebAssemblyHostBuilder.CreateDefault(args);
builder.RootComponents.Add<App>("#app");
builder.RootComponents.Add<HeadOutlet>("head::after");

builder.Services.AddScoped(sp => new HttpClient { BaseAddress = new Uri("http://localhost:5028/") });

builder.Services.AddBlazoredLocalStorage();
builder.Services.AddScoped<UserRepository>();

builder.Services.AddScoped<ProjectService>();


await builder.Build().RunAsync();

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Client\_Imports.razor -----

@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components.WebAssembly.Http
@using Microsoft.JSInterop
@using Client
@using Client.Layout

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Core\Login.cs -----

namespace Core;

public class Login
{
    public string UserName { get; set; }
    
    public string Password { get; set; }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Core\Project.cs -----

namespace Core;

public class Project
{
    public int ProjectId { get; set; }

    public string Name { get; set; } = string.Empty;

    public DateTime DateCreated { get; set; }

    // Timepriser pr. type medarbejder
    public decimal SvendTimePris { get; set; }
    public decimal L√¶rlingTimePris { get; set; }
    public decimal KonsulentTimePris { get; set; }
    public decimal ArbejdsmandTimePris { get; set; }

    // Liste af huse til projektet
    public List<House>? Houses { get; set; }

    // Total omkostninger kunde/virksomhed (dummy eller beregnet senere)
    public decimal TotalCostCustomer { get; set; }
    public decimal TotalCostCompany { get; set; }

    public List<TimeEntry> TimeEntries { get; set; } = new();
}

public class House
{
    public string Name { get; set; } = string.Empty;

    public decimal CostCustomer { get; set; }
    public decimal CostCompany { get; set; }
    public double Hours { get; set; }

    public Dictionary<string, decimal> InstallationCosts { get; set; } = new();
    public Dictionary<string, int> MaterialsUsed { get; set; } = new();
}


public class TimeEntry
{
    public DateTime Date { get; set; }
    public double Hours { get; set; }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Core\User.cs -----

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Core;


public class Users
{
    public int UserId { get; set; }

    public string UserName { get; set; } = String.Empty;

    public string Password { get; set; } = String.Empty;

    public string Role { get; set; } = "none";
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Controllers\UserCon\UserController.cs -----

using Core;
using Microsoft.AspNetCore.Mvc;
using Server.Repositories.User;

namespace ServerApp.Controllers
{
    [ApiController]
    [Route("api/user")]
    public class UserController : ControllerBase
    {

        private ICreateUserRepoSQL userRepo;

        public UserController(ICreateUserRepoSQL userRepo)
        {
            this.userRepo = userRepo;
        }

        [HttpGet]
        public IEnumerable<Users> Get()
        {
            return userRepo.GetAll();
        }

        [HttpPost]
        public void Add(Users user)
        {
            userRepo.Add(user);
        }
        
        [HttpPost("login")]
        public ActionResult<Users> Login([FromBody] Login dto)
        {
            var user = userRepo.ValidateUser(dto.UserName, dto.Password); // vi tilf¯jer denne metode til repo
            if (user == null)
                return Unauthorized(); // 401
            return Ok(user);
        }

        [HttpDelete]
        [Route("delete/{id:int}")]
        public void Delete(int id)
        {
            userRepo.Delete(id);
        }

        [HttpDelete]
        [Route("delete")]
        public void DeleteByQuery([FromQuery] int id)
        {
            userRepo.Delete(id);
        }



    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Controllers\ProjectController.cs -----

using Core;
using Microsoft.AspNetCore.Mvc;

namespace Server.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class ProjectController : ControllerBase
    {
        private static readonly List<Project> _projects = new();

        [HttpPost]
        public IActionResult Create(Project project)
        {
            project.ProjectId = _projects.Count + 1;
            project.DateCreated = DateTime.Now;

            _projects.Add(project);
            return Ok(project);
        }

        [HttpGet]
        public IActionResult GetAll()
        {
            return Ok(_projects);
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\PW1\PASSWORD.cs -----

namespace Server.PW1
{
    public class PASSWORD
    {
        public const string PW1 = "npg_K1orHF5vQyhm";
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Repositories\Project\IProjectRepo.cs -----

namespace Server.Repositories.Project
{
    public class IProjectRepo
    {
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Repositories\Project\ProjectMock.cs -----

namespace Server.Repositories.Project
{
    public class ProjectMock
    {
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Repositories\User\CreateUserRepoSQL.cs -----

using Core;
using Npgsql;
using Server.PW1;

namespace Server.Repositories.User
{
    public class CreateUserRepoSQL : ICreateUserRepoSQL
    {
        private const string conString =
    "Host=ep-spring-unit-a2y1k0pd.eu-central-1.aws.neon.tech;" +
    "Port=5432;" +
    "Database=LarsenInstallation;" +
    "Username=neondb_owner;" +
    $"Password={PASSWORD.PW1};" +
    "Ssl Mode=Require;" +
    "Trust Server Certificate=true;";

        public CreateUserRepoSQL()
        {

        }
        public List<Users> GetAll()
        {
            var result = new List<Users>();


            using (var mConnection = new NpgsqlConnection(conString))
            {
                mConnection.Open();
                var command = mConnection.CreateCommand();
                command.CommandText = @"SELECT * FROM Users";

                using (var reader = command.ExecuteReader())
                {
                    while (reader.Read())
                    {
                        var userid = reader.GetInt32(0);
                        var username = reader.GetString(1);
                        var password = reader.GetString(2);
                        var role = reader.GetString(3);

                        Users u = new Users
                        {
                            UserId = userid,
                            UserName = username,
                            Password = password,
                            Role = role
                        };
                        result.Add(u);
                    }
                }
            }

            return result;
        }

        public void Add(Users user)
        {
            using (var mConnection = new NpgsqlConnection(conString))
            {
                mConnection.Open();
                var command = mConnection.CreateCommand();

                command.CommandText =
                    "INSERT INTO Users (username, password, role) VALUES (@username, @password, @role)";

                Console.WriteLine(command.CommandText);
                var paramName = command.CreateParameter();
                paramName.ParameterName = "username";
                command.Parameters.Add(paramName);
                paramName.Value = user.UserName;

                var paramPassword = command.CreateParameter();
                paramPassword.ParameterName = "password";
                command.Parameters.Add(paramPassword);
                paramPassword.Value = user.Password;

                var paramRole = command.CreateParameter();
                paramRole.ParameterName = "role";
                command.Parameters.Add(paramRole);
                paramRole.Value = user.Role;

                command.ExecuteNonQuery();
            }
        }
        
        public Users? ValidateUser(string username, string password)
        {
            return GetAll().FirstOrDefault(u => u.UserName == username && u.Password == password);
        }

        public void Delete(int id)
        {
            using (var mConnection = new NpgsqlConnection(conString))
            {
                mConnection.Open();
                var command = mConnection.CreateCommand();

                command.CommandText = $"DELETE FROM users WHERE userid={id}";
                command.ExecuteNonQuery();
            }
        }
    }
}



// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Repositories\User\ICreateUserRepoSQL.cs -----

using Core;
using System.Collections.Generic;
namespace Server.Repositories.User
{
    public interface ICreateUserRepoSQL
    {
        List<Users> GetAll();
        void Add(Users user);
        void Delete(int id);
        Users? ValidateUser(string username, string password);
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Service\ExcelFileHelper.cs -----

using ExcelDataReader;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Service;

public class ExcelFileHelper
{
    public static bool SaveAsCsv(string excelFilePath, string destinationCsvFilePath)
    {

        using (var stream = new FileStream(excelFilePath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
        {
            Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);

            IExcelDataReader reader = null;
            if (excelFilePath.EndsWith(".xls"))
            {
                reader = ExcelReaderFactory.CreateBinaryReader(stream);
            }
            else if (excelFilePath.EndsWith(".xlsx"))
            {
                reader = ExcelReaderFactory.CreateOpenXmlReader(stream);
            }

            if (reader == null)
                return false;

            var ds = reader.AsDataSet(new ExcelDataSetConfiguration()
            {
                ConfigureDataTable = (tableReader) => new ExcelDataTableConfiguration()
                {
                    UseHeaderRow = false
                }
            });

            var csvContent = string.Empty;
            int row_no = 0;
            while (row_no < ds.Tables[0].Rows.Count)
            {
                var arr = new List<string>();
                for (int i = 0; i < ds.Tables[0].Columns.Count; i++)
                {
                    arr.Add(ds.Tables[0].Rows[row_no][i].ToString());
                }
                row_no++;
                csvContent += string.Join(",", arr) + "\n";
            }
            StreamWriter csv = new StreamWriter(destinationCsvFilePath, false);
            csv.Write(csvContent);
            csv.Close();
            return true;
        }
    }
}

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Service\ExcelReader.cs -----

using System.Data;
using System.Text;
using ExcelDataReader;

/* namespace Service;

public class ExcelReader
{
        string excelFilePath = "data.xlsx";
        using (var stream = new FileStream(excelFilePath, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
        {
            Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);

            IExcelDataReader reader = null;
            if (excelFilePath.EndsWith(".xls"))
            {
                reader = ExcelReaderFactory.CreateBinaryReader(stream);
            }
            else if (excelFilePath.EndsWith(".xlsx"))
            {
                reader = ExcelReaderFactory.CreateOpenXmlReader(stream);
            }

            if (reader == null)
                throw new Exception("could not read excel-file");

            var ds = reader.AsDataSet();
            
            int row_no = 1;
            DataRowCollection rows = ds.Tables[0].Rows;
            while (row_no < rows.Count)
            {
                DataRow aRow = rows[row_no];
                //dato in idx 0
                string dato = aRow[0].ToString();
                
                // timer in idx 2
                string timer = aRow[2].ToString();
                int timerAsInt = int.Parse(timer);
                

                Console.WriteLine($"{row_no}: {dato}, {timerAsInt}");
                row_no++;
            }
            
        }
}*/

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\Server\Program.cs -----

using Server.Repositories.User;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddSingleton<ICreateUserRepoSQL, CreateUserRepoSQL>();

builder.Services.AddControllers();

builder.Services.AddCors(options =>
{
    options.AddPolicy("policy",
        policy =>
        {
            policy.AllowAnyOrigin();
            policy.AllowAnyMethod();
            policy.AllowAnyHeader();
        });
});

// Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
builder.Services.AddOpenApi();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.MapOpenApi();
}

app.UseCors("policy");

//app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.Run();

// ----- C:\Users\lille\Source\Repos\LarsenInstallation\TestExcel\Program.cs -----

